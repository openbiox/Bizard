---
title: Circle Plot of Cell-Cell Communication Network
author:
  - "**[Editor]** GitHub Copilot"
---

细胞-细胞通讯在多细胞生物体中扮演着至关重要的角色，细胞通过各种信号分子和受体协调其活动。理解这些通讯网络对于发育生物学、免疫学和癌症研究等领域至关重要。圆形图（也称为弦图）提供了一种直观的可视化方式，展示细胞-细胞相互作用的方向性和强度，从而更容易在复杂的生物系统中识别关键信号模式和枢纽细胞类型。

## 示例

<!-- Image source: https://github.com/user-attachments/assets/43e63ab6-0ba8-4547-a84c-fa116f314f5a -->
![](../images/Omics/CellCommunicationCirclePlot_demo.png){fig-alt="CellCommunicationCirclePlot DEMO" fig-align="center" width="60%"}

上面的示例展示了一个以圆形图显示的细胞-细胞通讯网络。圆上的每个节点代表不同的细胞类型（例如，B细胞、CD8 T细胞、CD14+单核细胞等），连接线（弦）代表细胞类型之间的通讯通路。弦的宽度和颜色强度表示相互作用的强度。

## 设置

-   系统要求：跨平台（Linux/MacOS/Windows）

-   编程语言：R

-   依赖包：`CellChat`；`patchwork`；`dplyr`

```{r packages setup, message=FALSE, warning=FALSE, output=FALSE}
# Installing necessary packages
if (!requireNamespace("devtools", quietly = TRUE)) {
  install.packages("devtools")
}
if (!requireNamespace("CellChat", quietly = TRUE)) {
  devtools::install_github("sqjin/CellChat")
}
if (!requireNamespace("patchwork", quietly = TRUE)) {
  install.packages("patchwork")
}
if (!requireNamespace("dplyr", quietly = TRUE)) {
  install.packages("dplyr")
}

# Load packages
library(CellChat)
library(patchwork)
library(dplyr)
```

```{r}
sessioninfo::session_info("attached")
```

## 数据准备

### 1. 加载数据

CellChat 需要带有细胞类型注释的单细胞 RNA-seq 数据。该软件包包含我们可以用于演示的示例数据集。

```{r load data1, message=FALSE}
# Load example data from CellChat
data("CellChatDB.human")
data("cellchat_humanSkin_LS")

# The cellchat object contains preprocessed data
cellchat <- cellchat_humanSkin_LS

# View basic information
cellchat
```

### 2. 探索通讯网络

加载 CellChat 对象后，我们可以探索推断的细胞-细胞通讯网络。

```{r load data2}
# Get the aggregated cell-cell communication network
# This shows the number of interactions between cell types
net <- cellchat@net$count

# View the first few rows and columns
net[1:5, 1:5]

# Get the total number of interactions per cell type
rowSums(net) %>% head()
```

### 3. 理解数据结构

CellChat 对象包含几个关键组件：
- `@data.signaling`：标准化的基因表达数据
- `@net`：推断的细胞-细胞通讯网络
- `@netP`：信号通路水平的通讯网络
- `@idents`：细胞类型标签

```{r load data3}
# View available cell types
levels(cellchat@idents)

# View number of cells per type
table(cellchat@idents)
```

## 可视化

### 1. 基础圆形图

最直接的可视化方式是在单个圆形图中显示所有的细胞-细胞通讯。

```{r fig1.1BasicCircle}
#| label: fig1.1BasicCircle
#| fig-cap: "Basic Circle Plot of Cell-Cell Communication"
#| out.width: "95%"
#| warning: false
#| message: false

# Basic circle plot showing all interactions
netVisual_circle(cellchat@net$count, 
                 vertex.weight = rowSums(cellchat@net$count),
                 weight.scale = TRUE,
                 label.edge = FALSE,
                 title.name = "Number of interactions")
```

::: callout-tip
**关键参数：**

- `vertex.weight`：根据相互作用强度控制节点（细胞类型）的大小
- `weight.scale`：是否按权重缩放边的宽度
- `label.edge`：是否在边上显示标签
- `arrow.width` 和 `arrow.size`：控制方向性箭头的外观
:::

### 2. 带细胞分组的圆形图

我们可以将细胞按类别分组来可视化通讯网络，这有助于识别不同细胞群之间的相互作用模式。

```{r fig1.2GroupedCircle}
#| label: fig1.2GroupedCircle
#| fig-cap: "Circle Plot with Cell Groups"
#| out.width: "95%"
#| warning: false
#| message: false

# Define cell groups (example: immune cells vs. structural cells)
groupSize <- as.numeric(table(cellchat@idents))

# Circle plot with custom colors
netVisual_circle(cellchat@net$count, 
                 vertex.weight = groupSize,
                 weight.scale = TRUE,
                 label.edge = FALSE,
                 title.name = "Number of interactions",
                 vertex.label.cex = 0.8,
                 vertex.size = groupSize/10)
```

### 3. 通路特异性圆形图

我们还可以可视化特定的信号通路，以了解哪些细胞类型参与了特定的生物过程。

```{r fig1.3PathwayCircle}
#| label: fig1.3PathwayCircle
#| fig-cap: "Circle Plot for Specific Pathways"
#| out.width: "95%"
#| warning: false
#| message: false

# Get available pathways
pathways <- cellchat@netP$pathways

# Visualize the first pathway (if available)
if(length(pathways) > 0) {
  pathway.show <- pathways[1]
  
  # Circle plot for a specific pathway
  netVisual_aggregate(cellchat, 
                      signaling = pathway.show, 
                      layout = "circle",
                      vertex.label.cex = 0.8,
                      title.name = paste0(pathway.show, " signaling pathway"))
}
```

::: callout-tip
**理解通路特异性图：**

通路特异性可视化有助于识别：
- 哪些细胞类型是特定信号的主要发送者或接收者
- 特定生物过程中的主导通讯模式
- 疾病背景下的潜在治疗靶点
:::

### 4. 比较传入和传出信号

比较每种细胞类型的传入和传出信号模式通常很有用。

```{r fig1.4SignalDirection}
#| label: fig1.4SignalDirection
#| fig-cap: "Incoming and Outgoing Signals"
#| out.width: "95%"
#| warning: false
#| message: false

# Calculate total outgoing and incoming signals
outgoing <- rowSums(cellchat@net$count)
incoming <- colSums(cellchat@net$count)

# Create a comparison data frame
signal_comparison <- data.frame(
  CellType = names(outgoing),
  Outgoing = outgoing,
  Incoming = incoming
)

# Show top cell types by outgoing signals
signal_comparison %>% 
  arrange(desc(Outgoing)) %>%
  head(5)
```

### 5. 分层图替代方案

除了圆形图，CellChat 还提供了分层布局，这对于某些类型的网络很有用。

```{r fig1.5Hierarchical}
#| label: fig1.5Hierarchical
#| fig-cap: "Hierarchical Plot of Cell-Cell Communication"
#| out.width: "95%"
#| warning: false
#| message: false

# Hierarchical plot
if(length(pathways) > 0) {
  netVisual_aggregate(cellchat, 
                      signaling = pathway.show, 
                      layout = "hierarchy",
                      vertex.label.cex = 0.8,
                      title.name = paste0(pathway.show, " signaling (hierarchical)"))
}
```

## 应用

### 疾病中的细胞-细胞通讯

细胞-细胞通讯网络的圆形图广泛用于生物医学研究，以了解：

1. **癌症微环境**：识别肿瘤细胞如何与免疫细胞和基质细胞通讯
2. **免疫反应**：理解不同免疫细胞类型在感染或炎症期间如何协调
3. **组织发育**：揭示器官发育和组织稳态过程中的信号模式
4. **疾病机制**：发现纤维化、神经退行性变或自身免疫性疾病等疾病中的异常通讯模式

### 最佳实践

在创建细胞-细胞通讯圆形图时：

- 过滤弱相互作用以专注于具有生物学意义的通讯
- 使用颜色编码突出显示特定的细胞群或感兴趣的通路
- 比较不同条件下的网络（例如，健康与疾病、治疗前后）
- 通过实验方法（如共培养实验或空间转录组学）验证关键发现

## 参考文献

\[1\] Jin, S., Guerrero-Juarez, C. F., Zhang, L., Chang, I., Ramos, R., Kuan, C. H., ... & Nie, Q. (2021). Inference and analysis of cell-cell communication using CellChat. *Nature communications*, 12(1), 1088. <https://doi.org/10.1038/s41467-021-21246-9>

\[2\] CellChat GitHub Repository: <https://github.com/sqjin/CellChat>

\[3\] CellChat Documentation: <http://www.cellchat.org/>