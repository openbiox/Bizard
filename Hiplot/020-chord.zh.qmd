---
title: "弦图"
author:
  - "**[编辑]** [郑虎](https://github.com/ZhengTiger);"
  - "**[审核]** [苗奔奔](https://github.com/benben-miao);"
---

::: callout-note
**Hiplot 网站**

本页面为 Hiplot `Chord Plot` 插件的源码版本教程，您也可以使用 Hiplot 网站实现无代码绘图，更多信息请查看以下链接:

<https://hiplot.cn/basic/chord?lang=zh_cn>
:::

弦图是一种展示矩阵数据中实体间关系网络的图表。它使用节点弧和彩色弦带直观呈现连接流向与强度，适合表现对称或非对称关系数据，如生物分子间相互作用关系、基因与生物学功能之间的归属关系。通过弦带的粗细变化，读者可快速捕捉关键连接模式。

## 环境配置

-   系统: Cross-platform (Linux/MacOS/Windows)

-   编程语言: R

-   依赖包: `data.table`; `jsonlite`; `circlize`; `ggplotify`

```{r packages setup, message=FALSE, warning=FALSE, output=FALSE}
# 安装包
if (!requireNamespace("data.table", quietly = TRUE)) {
  install.packages("data.table")
}
if (!requireNamespace("jsonlite", quietly = TRUE)) {
  install.packages("jsonlite")
}
if (!requireNamespace("circlize", quietly = TRUE)) {
  install.packages("circlize")
}
if (!requireNamespace("ggplotify", quietly = TRUE)) {
  install.packages("ggplotify")
}

# 加载包
library(data.table)
library(jsonlite)
library(circlize)
library(ggplotify)
```

## 数据准备

基因与通路或基因本体相互作用的数据框架或矩阵。

```{r load data, message=FALSE, warning=FALSE}
# 加载数据
data <- data.table::fread(jsonlite::read_json("https://hiplot.cn/ui/basic/chord/data.json")$exampleData$textarea[[1]])
data <- as.data.frame(data)

# 整理数据
row.names(data) <- data[, 1]
data <- data[, -1]
data <- as.matrix(data)

# 查看数据
head(data)
```


## 可视化

### 1. 对称弦图

```{r fig-1Chi-square-fisher}
#| label: fig-1Chord
#| fig-cap: "对称弦图"
#| out.width: "95%"
#| warning: false
#| message: false
#| fig-height: 6
#| fig-width: 6

# 颜色定义
Palette <- c("#E64B35FF","#4DBBD5FF","#00A087FF","#3C5488FF","#F39B7FFF",
             "#8491B4FF","#91D1C2FF","#DC0000FF","#7E6148FF","#B09C85FF")
grid.col <- c(Palette, Palette, Palette[1:5])

# 绘制弦图
p <- as.ggplot(function() {
  chordDiagram(
    data, 
    grid.col = grid.col,        # 设置节点颜色
    grid.border = NULL,         # 节点边框设为无
    transparency = 0.5,         # 弦带透明度50%
    row.col = NULL,             # 行颜色（默认）
    column.col = NULL,          # 列颜色（默认）  
    order = NULL,               # 节点顺序（默认）
    
    # 方向性设置
    directional = 0,            # 0=无方向, 1=正向, -1=反向, 2=双向
    direction.type = "diffHeight", # 方向显示类型："diffHeight"和"arrows"
    diffHeight = convert_height(2, "mm"), # 方向高度差
    
    # 布局参数
    reduce = 1e-5,              # 减少小扇区的最小间隔
    xmax = NULL,                # 最大x坐标（自动计算）
    self.link = 2,              # 自连接样式：1=单边, 2=双边
    symmetric = FALSE,          # 是否对称矩阵
    keep.diagonal = FALSE,      # 是否保留对角线
    
    # 轨道设置
    preAllocateTracks = NULL,   # 预分配轨道
    annotationTrack = c("name", "grid", "axis"), # 显示名称、网格和坐标轴
    annotationTrackHeight = convert_height(c(3, 3), "mm"), # 轨道高度
    
    # 连接线样式
    link.border = NA,           # 连接线边框（无）
    link.lwd = par("lwd"),      # 连接线宽度
    link.lty = par("lty"),      # 连接线类型
    link.sort = FALSE,          # 是否排序连接
    link.decreasing = TRUE,     # 连接排序方式
    link.largest.ontop = FALSE, # 最大连接是否在顶部
    link.visible = TRUE,        # 连接是否可见
    link.rank = NULL,           # 连接层级
    link.overlap = FALSE,       # 连接是否允许重叠
    
    # 分组和间距
    scale = FALSE,              # 是否缩放弦带宽度
    group = NULL,               # 分组设置
    big.gap = 10,               # 大组间间距（度）
    small.gap = 1               # 小组内间距（度）
  )
})

p
```

### 2. 比例弦图

```{r fig-1Chi-square-fisher}
#| label: fig-2SymmetricChord
#| fig-cap: "比例弦图"
#| out.width: "95%"
#| warning: false
#| message: false
#| fig-height: 6
#| fig-width: 6

# 颜色定义
Palette <- c("#E64B35FF","#4DBBD5FF","#00A087FF","#3C5488FF","#F39B7FFF",
             "#8491B4FF","#91D1C2FF","#DC0000FF","#7E6148FF","#B09C85FF")
grid.col <- c(Palette, Palette, Palette[1:5])

# 绘制弦图
p <- as.ggplot(function() {
  chordDiagram(
    data, 
    grid.col = grid.col,        # 设置节点颜色
    grid.border = NULL,         # 节点边框设为无
    transparency = 0.5,         # 弦带透明度50%
    row.col = NULL,             # 行颜色（默认）
    column.col = NULL,          # 列颜色（默认）  
    order = NULL,               # 节点顺序（默认）
    
    # 方向性设置
    directional = 0,            # 0=无方向, 1=正向, -1=反向, 2=双向
    direction.type = "diffHeight", # 方向显示类型："diffHeight"和"arrows"
    diffHeight = convert_height(2, "mm"), # 方向高度差
    
    # 布局参数
    reduce = 1e-5,              # 减少小扇区的最小间隔
    xmax = NULL,                # 最大x坐标（自动计算）
    self.link = 2,              # 自连接样式：1=单边, 2=双边
    symmetric = FALSE,          # 是否对称矩阵
    keep.diagonal = FALSE,      # 是否保留对角线
    
    # 轨道设置
    preAllocateTracks = NULL,   # 预分配轨道
    annotationTrack = c("name", "grid", "axis"), # 显示名称、网格和坐标轴
    annotationTrackHeight = convert_height(c(3, 3), "mm"), # 轨道高度
    
    # 连接线样式
    link.border = NA,           # 连接线边框（无）
    link.lwd = par("lwd"),      # 连接线宽度
    link.lty = par("lty"),      # 连接线类型
    link.sort = FALSE,          # 是否排序连接
    link.decreasing = TRUE,     # 连接排序方式
    link.largest.ontop = FALSE, # 最大连接是否在顶部
    link.visible = TRUE,        # 连接是否可见
    link.rank = NULL,           # 连接层级
    link.overlap = FALSE,       # 连接是否允许重叠
    
    # 分组和间距
    scale = TRUE,              # 是否缩放弦带宽度
    group = NULL,               # 分组设置
    big.gap = 10,               # 大组间间距（度）
    small.gap = 1               # 小组内间距（度）
  )
})

p
```